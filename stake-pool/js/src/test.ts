import * as index from './index.js';
import * as schema from './schema.js';
import BN from 'bn.js';
import assert, {deepStrictEqual} from 'assert';
import {SOLANA_SCHEMA, PublicKey, Connection} from '@solana/web3.js';

// First populate schema
schema.addStakePoolSchema(SOLANA_SCHEMA);

function deepStrictEqualBN(decodedData: object, expectedData: object) {
  /**
   * Helper function to do deep equality check because BNs are not equal.
   * TODO: write this function recursively. For now, sufficient.
   */
  for (const key in decodedData) {
    if (expectedData[key] instanceof BN) {
      assert.ok(expectedData[key].eq(decodedData[key]));
    } else {
      if (decodedData[key] instanceof Object) {
        for (const subkey in decodedData[key]) {
          if (decodedData[key][subkey] instanceof Object) {
            if (decodedData[key][subkey] instanceof BN) {
              assert.ok(decodedData[key][subkey].eq(expectedData[key][subkey]));
            } else {
              for (const subsubkey in decodedData[key][subkey]) {
                console.log(decodedData[key][subkey][subsubkey]);
                if (decodedData[key][subkey][subsubkey] instanceof BN) {
                  assert.ok(
                    decodedData[key][subkey][subsubkey].eq(
                      expectedData[key][subkey][subsubkey],
                    ),
                  );
                } else {
                  assert.deepStrictEqual(
                    expectedData[key][subkey][subsubkey],
                    decodedData[key][subkey][subsubkey],
                  );
                }
              }
            }
          } else {
            assert.strictEqual(
              decodedData[key][subkey],
              expectedData[key][subkey],
            );
          }
        }
      } else {
        assert.strictEqual(decodedData[key], expectedData[key]);
      }
    }
  }
}

describe('schema.decode', () => {
  describe('StakePoolAccount', () => {
    it('should successfully decode StakePoolAccount account data', () => {
      const decodedData = schema.StakePool.decode(
        new Buffer(
          '014f962536a1b5b3a1f1036599ca7c164d6ad0677fed896f12ecdd09ada2cd23dc4f962536a1b5b3a1f1036599ca7c164d6ad0677fed896f12ecdd09ada2cd23dcbb09705cd25f4ad3b9e2c78e3f62ba3e290f798150499edc4f851a1a45e71159ff1086831390e666d64d18cac8f0c86eb91d799eda647319634280b89548ba0371ee618745ef3ebb93164e66ac3560e934b04e49b89ad38baa3b104284abb1a574003e566772f55676cf243c647fab463afa138cb156d2080062d2957b10bf22870fdbe150fc449db6268eb9214a848a90162d9bd4bb81e722cacb41d3dcb483b706ddf6e1d765a193d9cbe146ceeb79ac1cb485ed5f5b37913a8cf5857eff00a9000000000000000000000000000000007c00000000000000e8030000000000003800000000000000',
          'hex',
        ),
      );
      const expectedData = new schema.StakePool({
        accountType: new schema.AccountType({
          StakePool: new schema.AccountTypeEnum({}),
        }),
        manager: new schema.PublicKey({
          value: new BN(
            'dc23cda2ad09ddec126f89ed7f67d06a4d167cca996503f1a1b3b5a13625964f',
            'hex',
          ),
        }),
        staker: new schema.PublicKey({
          value: new BN(
            'dc23cda2ad09ddec126f89ed7f67d06a4d167cca996503f1a1b3b5a13625964f',
            'hex',
          ),
        }),
        depositAuthority: new schema.PublicKey({
          value: new BN(
            new Buffer(
              '5911e7451a1a854fdc9e495081790f293eba623f8ec7e2b9d34a5fd25c7009bb',
              'hex',
            ),
          ),
        }),
        withdrawBumpSeed: 255,
        validatorList: new schema.PublicKey({
          value: new BN(
            '7103ba4895b8804263197364da9e791db96ec8f0c8ca184dd666e69013838610',
            'hex',
          ),
        }),
        reserveStake: new schema.PublicKey({
          value: new BN(
            '74a5b1ab8442103baa8bd39ab8494eb034e96035ac664e1693bb3eef458761ee',
            'hex',
          ),
        }),
        poolMint: new schema.PublicKey({
          value: new BN(
            '8722bf107b95d2620008d256b18c13fa3a46ab7f643c24cf7656f57267563e00',
            'hex',
          ),
        }),
        managerFeeAccount: new schema.PublicKey({
          value: new BN(
            new Buffer(
              'b783b4dcd341cbca22e781bbd49b2d16908a844a21b98e26b69d44fc50e1db0f',
              'hex',
            ),
          ),
        }),
        tokenProgramId: new schema.PublicKey({
          value: new BN(
            'a900ff7e85f58c3a91375b5fed85b41cac79ebce46e1cbd993a165d7e1f6dd06',
            'hex',
          ),
        }),
        totalStakeLamports: new BN('0', 'hex'),
        poolTokenSupply: new BN('0', 'hex'),
        lastUpdateEpoch: new BN('7c', 'hex'),
        fee: new schema.Fee({
          denominator: new BN('3e8', 'hex'),
          numerator: new BN('38', 'hex'),
        }),
      });

      deepStrictEqualBN(decodedData, expectedData);
    });
  });

  describe('ValidatorListAccount', () => {
    it('should successfully decode ValidatorListAccount account data', () => {
      const decodedData = schema.ValidatorList.decodeUnchecked(
        new Buffer(
          '020a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
          'hex',
        ),
      );
      const expectedData = new schema.ValidatorList({
        accountType: new schema.AccountType({
          ValidatorList: new schema.AccountTypeEnum({}),
        }),
        maxValidators: 10,
        validators: [],
      });

      assert.deepStrictEqual(decodedData, expectedData);
    });

    it('should successfully decode ValidatorListAccount with nonempty ValidatorInfo', () => {
      // TODO also test for decoding ValidatorListAccount with actual ValidatorInfo
      // Do this once we have a stake pool with validators deployed on testnet

      const decodedData = schema.ValidatorList.decodeUnchecked(
        new Buffer(
          '026400000003000000008c2f1af21cb4fc9031ff096b1a2799969d4809f35d3db3c9d34ff19a886a94a90000000000000000c300000000000000007d9f6ac01f4c039bbc6e695f46404c1d473034f7e31741c6e307ee4506d496370000000000000000c30000000000000000f84c78d920a30a78865b82a2efa6cde57be50463a0a83d0fbbc0802e6f7de3e40000000000000000c30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
          'hex',
        ),
      );

      const expectedData = new schema.ValidatorList({
        accountType: new schema.AccountType({
          ValidatorList: new schema.AccountTypeEnum({}),
        }),
        maxValidators: 100,
        validators: [
          new schema.ValidatorStakeInfo({
            status: new schema.StakeStatus({
              Active: new schema.StakeStatusEnum({}),
            }),
            voteAccountAddress: new schema.PublicKey({
              value: new BN(
                'a9946a889af14fd3c9b33d5df309489d9699271a6b09ff3190fcb41cf21a2f8c',
                'hex',
              ),
            }),
            stakeLamports: new BN('0', 'hex'),
            lastUpdateEpoch: new BN('c3', 'hex'),
          }),
          new schema.ValidatorStakeInfo({
            status: new schema.StakeStatus({
              Active: new schema.StakeStatusEnum({}),
            }),
            voteAccountAddress: new schema.PublicKey({
              value: new BN(
                '3796d40645ee07e3c64117e3f73430471d4c40465f696ebc9b034c1fc06a9f7d',
                'hex',
              ),
            }),
            stakeLamports: new BN('0', 'hex'),
            lastUpdateEpoch: new BN('c3', 'hex'),
          }),
          new schema.ValidatorStakeInfo({
            status: new schema.StakeStatus({
              Active: new schema.StakeStatusEnum({}),
            }),
            voteAccountAddress: new schema.PublicKey({
              value: new BN(
                'e4e37d6f2e80c0bb0f3da8a06304e57be5cda6efa2825b86780aa320d9784cf8',
                'hex',
              ),
            }),
            stakeLamports: new BN('0', 'hex'),
            lastUpdateEpoch: new BN('c3', 'hex'),
          }),
        ],
      });

      deepStrictEqualBN(decodedData, expectedData);
    });
  });
});

describe('index.ts/PrettyPrintPubkey', () => {
  it('should successfully pretty print a pubkey', () => {
    assert.equal(
      index.prettyPrintPubKey(
        new schema.PublicKey({
          value: new BN(
            '99572085579321386496717000324290408927851378839748241098946587626478579848783',
          ),
        }),
      ),
      '6MfzrQUzB2mozveRWU9a77zMoQzSrYa4Gq46KswjupQB',
    );
  });
});

describe('Integration test', () => {
  it('should successfully decode all validators from devnet', async () => {
    /**
     * Full integration test:
     * Makes a connection to devnet, gets all stake pool accounts there,
     * decodes them, and prints their details.
     */
    const connection = new Connection(
      'https://api.devnet.solana.com/',
      'confirmed',
    );
    const STAKE_POOL_PROGRAM_ADDR = new PublicKey(
      'poo1B9L9nR3CrcaziKVYVpRX6A9Y1LAXYasjjfCbApj',
    );

    const accounts = await index.getStakePoolAccounts(
      connection,
      STAKE_POOL_PROGRAM_ADDR,
    );

    console.log('Number of stake pool accounts in devnet: ', accounts.length);

    accounts.map(account => {
      // index.prettyPrintAccount(account);
      // console.log('\n');
    });
  });

  it('should successfully decode all validators from testnet', async () => {
    /**
     * Full integration test:
     * Makes a connection to testnet, gets all stake pool accounts there,
     * decodes them, and prints their details.
     * Testnet presents a greater challenge due to the presence of old stake pool program accounts
     */
    const connection = new Connection(
      'https://api.testnet.solana.com/',
      'confirmed',
    );
    const STAKE_POOL_PROGRAM_ADDR = new PublicKey(
      'poo1B9L9nR3CrcaziKVYVpRX6A9Y1LAXYasjjfCbApj',
    );

    const accounts = await index.getStakePoolAccounts(
      connection,
      STAKE_POOL_PROGRAM_ADDR,
    );

    console.log('Number of stake pool accounts in testnet: ', accounts.length);

    accounts.map(account => {
      // console.log(account)
      // index.prettyPrintAccount(account);
      // console.log('\n');
    });
  });
});
